// Comprehensive Delhi NCR locations with coordinates
export const delhiLocations = [
  // Central Delhi
  {
    name: "Connaught Place",
    area: "Central Delhi",
    coordinates: { latitude: 28.6315, longitude: 77.2167 },
    radius: 1.5,
    landmarks: ["Metro Station", "Palika Bazaar", "Janpath"]
  },
  {
    name: "India Gate",
    area: "Central Delhi", 
    coordinates: { latitude: 28.6129, longitude: 77.2295 },
    radius: 2.0,
    landmarks: ["War Memorial", "Rajpath", "President House"]
  },
  {
    name: "Khan Market",
    area: "Central Delhi",
    coordinates: { latitude: 28.5983, longitude: 77.2319 },
    radius: 0.8,
    landmarks: ["Shopping Complex", "Restaurants", "Lodhi Gardens"]
  },
  {
    name: "Karol Bagh",
    area: "Central Delhi",
    coordinates: { latitude: 28.6519, longitude: 77.1909 },
    radius: 1.5,
    landmarks: ["Main Market", "Metro Station", "Gaffar Market"]
  },
  
  // Old Delhi
  {
    name: "Red Fort",
    area: "Old Delhi",
    coordinates: { latitude: 28.6562, longitude: 77.2410 },
    radius: 1.0,
    landmarks: ["Chandni Chowk", "Jama Masjid", "Lal Qila"]
  },
  {
    name: "Chandni Chowk",
    area: "Old Delhi",
    coordinates: { latitude: 28.6506, longitude: 77.2334 },
    radius: 1.0,
    landmarks: ["Red Fort", "Jama Masjid", "Spice Market"]
  },
  
  // South Delhi
  {
    name: "Lajpat Nagar",
    area: "South Delhi",
    coordinates: { latitude: 28.5677, longitude: 77.2436 },
    radius: 1.2,
    landmarks: ["Central Market", "Metro Station", "Ring Road"]
  },
  {
    name: "Saket",
    area: "South Delhi",
    coordinates: { latitude: 28.5245, longitude: 77.2066 },
    radius: 2.0,
    landmarks: ["Select City Walk", "Metro Station", "DLF Mall"]
  },
  {
    name: "Nehru Place",
    area: "South Delhi",
    coordinates: { latitude: 28.5494, longitude: 77.2519 },
    radius: 1.5,
    landmarks: ["IT Market", "Metro Station", "Commercial Hub"]
  },
  {
    name: "Vasant Kunj",
    area: "South Delhi",
    coordinates: { latitude: 28.5200, longitude: 77.1591 },
    radius: 2.0,
    landmarks: ["Ambience Mall", "DLF Malls", "Residential Area"]
  },
  {
    name: "Greater Kailash",
    area: "South Delhi",
    coordinates: { latitude: 28.5355, longitude: 77.2420 },
    radius: 1.8,
    landmarks: ["M Block Market", "N Block Market", "Metro Station"]
  },
  {
    name: "Defence Colony",
    area: "South Delhi",
    coordinates: { latitude: 28.5729, longitude: 77.2294 },
    radius: 1.2,
    landmarks: ["Market", "Flyover", "Lajpat Nagar Metro"]
  },
  
  // North Delhi
  {
    name: "Model Town",
    area: "North Delhi",
    coordinates: { latitude: 28.7041, longitude: 77.2025 },
    radius: 1.8,
    landmarks: ["Model Town Metro", "Shopping Complex", "Azadpur"]
  },
  {
    name: "Civil Lines",
    area: "North Delhi",
    coordinates: { latitude: 28.6769, longitude: 77.2232 },
    radius: 1.5,
    landmarks: ["Delhi University", "Kamla Nagar", "Mall Road"]
  },
  {
    name: "Kamla Nagar",
    area: "North Delhi",
    coordinates: { latitude: 28.6816, longitude: 77.2094 },
    radius: 1.2,
    landmarks: ["Shopping Market", "GTB Nagar Metro", "University Area"]
  },
  {
    name: "Burari",
    area: "North Delhi",
    coordinates: { latitude: 28.7594, longitude: 77.2022 },
    radius: 2.0,
    landmarks: ["Burari Crossing", "Sant Nagar", "Yamuna Bank"]
  },
  {
    name: "Sant Nagar",
    area: "North Delhi",
    coordinates: { latitude: 28.7520, longitude: 77.1980 },
    radius: 1.5,
    landmarks: ["Burari Road", "Community Center", "Local Market"]
  },
  {
    name: "Narela",
    area: "North Delhi",
    coordinates: { latitude: 28.8553, longitude: 77.0892 },
    radius: 2.5,
    landmarks: ["Industrial Area", "Narela Metro", "Bawana Road"]
  },
  
  // North West Delhi
  {
    name: "Rohini",
    area: "North West Delhi",
    coordinates: { latitude: 28.7041, longitude: 77.1025 },
    radius: 2.2,
    landmarks: ["Sector 3 Metro", "Unity Mall", "Commercial Area"]
  },
  {
    name: "Pitampura",
    area: "North West Delhi",
    coordinates: { latitude: 28.6942, longitude: 77.1314 },
    radius: 1.6,
    landmarks: ["Metro Station", "TV Tower", "Commercial Area"]
  },
  {
    name: "Shalimar Bagh",
    area: "North West Delhi",
    coordinates: { latitude: 28.7196, longitude: 77.1641 },
    radius: 1.8,
    landmarks: ["Metro Station", "Shopping Complex", "Ring Road"]
  },
  {
    name: "Kohat Enclave",
    area: "North West Delhi",
    coordinates: { latitude: 28.6889, longitude: 77.1389 },
    radius: 1.4,
    landmarks: ["Pitampura Metro", "Commercial Area", "Residential Colony"]
  },
  
  // West Delhi
  {
    name: "Rajouri Garden",
    area: "West Delhi",
    coordinates: { latitude: 28.6692, longitude: 77.1174 },
    radius: 1.3,
    landmarks: ["Metro Station", "Shopping Mall", "Market"]
  },
  {
    name: "Janakpuri",
    area: "West Delhi",
    coordinates: { latitude: 28.6219, longitude: 77.0814 },
    radius: 1.8,
    landmarks: ["Metro Station", "District Centre", "Market"]
  },
  {
    name: "Tilak Nagar",
    area: "West Delhi",
    coordinates: { latitude: 28.6420, longitude: 77.0938 },
    radius: 1.5,
    landmarks: ["Metro Station", "Main Market", "Subhash Nagar"]
  },
  {
    name: "Vikaspuri",
    area: "West Delhi",
    coordinates: { latitude: 28.6078, longitude: 77.0266 },
    radius: 1.7,
    landmarks: ["Metro Station", "Shopping Complex", "Residential Area"]
  },
  
  // South West Delhi
  {
    name: "Dwarka",
    area: "South West Delhi",
    coordinates: { latitude: 28.5921, longitude: 77.0460 },
    radius: 2.5,
    landmarks: ["Sector 21 Metro", "City Center", "NSIT College"]
  },
  {
    name: "Dwarka Mor",
    area: "South West Delhi",
    coordinates: { latitude: 28.5889, longitude: 77.0583 },
    radius: 1.8,
    landmarks: ["Metro Station", "Bus Terminal", "Market"]
  },
  
  // East Delhi
  {
    name: "Laxmi Nagar",
    area: "East Delhi",
    coordinates: { latitude: 28.6345, longitude: 77.2767 },
    radius: 1.4,
    landmarks: ["Metro Station", "Market", "Vikas Marg"]
  },
  {
    name: "Mayur Vihar",
    area: "East Delhi",
    coordinates: { latitude: 28.6127, longitude: 77.2773 },
    radius: 1.5,
    landmarks: ["Metro Station", "Phase 1 Market", "Yamuna Bank"]
  },
  {
    name: "Preet Vihar",
    area: "East Delhi",
    coordinates: { latitude: 28.6292, longitude: 77.2947 },
    radius: 1.3,
    landmarks: ["Metro Station", "V3S Mall", "Vikas Marg"]
  },
  {
    name: "Shahdara",
    area: "East Delhi",
    coordinates: { latitude: 28.6692, longitude: 77.2884 },
    radius: 1.6,
    landmarks: ["Metro Station", "GT Road", "Old Market"]
  },
  {
    name: "Swaroop Nagar",
    area: "North East Delhi",
    coordinates: { latitude: 28.6833, longitude: 77.2667 },
    radius: 1.4,
    landmarks: ["Swaroop Nagar Metro", "Main Market", "Shastri Park"]
  },
  
  // Gurgaon (Gurugram)
  {
    name: "Gurgaon Cyber City",
    area: "Gurgaon",
    coordinates: { latitude: 28.4595, longitude: 77.0266 },
    radius: 2.0,
    landmarks: ["DLF Cyber City", "Metro Station", "IT Hub"]
  },
  {
    name: "MG Road Gurgaon",
    area: "Gurgaon",
    coordinates: { latitude: 28.4601, longitude: 77.0648 },
    radius: 1.8,
    landmarks: ["MGF Mall", "Metro Station", "Commercial Area"]
  },
  {
    name: "Sector 14 Gurgaon",
    area: "Gurgaon",
    coordinates: { latitude: 28.4595, longitude: 77.0368 },
    radius: 1.5,
    landmarks: ["Old Gurgaon", "Railway Station", "Market"]
  },
  
  // Ghaziabad
  {
    name: "Ghaziabad",
    area: "Ghaziabad",
    coordinates: { latitude: 28.6692, longitude: 77.4538 },
    radius: 2.5,
    landmarks: ["Railway Station", "Bus Stand", "Raj Nagar"]
  },
  {
    name: "Raj Nagar Ghaziabad",
    area: "Ghaziabad",
    coordinates: { latitude: 28.6667, longitude: 77.4167 },
    radius: 2.0,
    landmarks: ["Extension Area", "Shopping Complex", "Metro Connectivity"]
  },
  {
    name: "Vaishali Ghaziabad",
    area: "Ghaziabad",
    coordinates: { latitude: 28.6507, longitude: 77.3450 },
    radius: 1.8,
    landmarks: ["Metro Station", "Sector 4", "Commercial Hub"]
  },
  
  // Noida
  {
    name: "Sector 18 Noida",
    area: "Noida",
    coordinates: { latitude: 28.5678, longitude: 77.3261 },
    radius: 2.0,
    landmarks: ["Atta Market", "Metro Station", "DLF Mall"]
  },
  {
    name: "Sector 62 Noida",
    area: "Noida",
    coordinates: { latitude: 28.6274, longitude: 77.3716 },
    radius: 1.8,
    landmarks: ["Electronic City Metro", "IT Companies", "Commercial Area"]
  },
  
  // Faridabad
  {
    name: "Faridabad",
    area: "Faridabad",
    coordinates: { latitude: 28.4089, longitude: 77.3178 },
    radius: 2.5,
    landmarks: ["Railway Station", "Crown Plaza", "Sector 16"]
  },

  // Additional Popular Delhi Areas
  {
    name: "Janakpuri West",
    area: "West Delhi",
    coordinates: { latitude: 28.6219, longitude: 77.0814 },
    radius: 1.5,
    landmarks: ["Metro Station", "District Centre", "Shopping Complex"]
  },
  {
    name: "Punjabi Bagh",
    area: "West Delhi",
    coordinates: { latitude: 28.6742, longitude: 77.1342 },
    radius: 1.3,
    landmarks: ["Metro Station", "Ring Road", "Market"]
  },
  {
    name: "Paschim Vihar",
    area: "West Delhi",
    coordinates: { latitude: 28.6692, longitude: 77.1025 },
    radius: 1.8,
    landmarks: ["Metro Station", "A Block Market", "Residential Area"]
  },
  {
    name: "Uttam Nagar",
    area: "West Delhi",
    coordinates: { latitude: 28.6219, longitude: 77.0594 },
    radius: 2.0,
    landmarks: ["Metro Station", "Main Market", "Dwarka Mor"]
  },
  {
    name: "Mayur Vihar Phase 1",
    area: "East Delhi",
    coordinates: { latitude: 28.6127, longitude: 77.2773 },
    radius: 1.2,
    landmarks: ["Metro Station", "Yamuna Bank", "IP Extension"]
  },
  {
    name: "Patparganj",
    area: "East Delhi",
    coordinates: { latitude: 28.6219, longitude: 77.2889 },
    radius: 1.4,
    landmarks: ["IP Extension", "Mayur Vihar", "Anand Vihar"]
  },
  {
    name: "Anand Vihar",
    area: "East Delhi",
    coordinates: { latitude: 28.6469, longitude: 77.3150 },
    radius: 1.6,
    landmarks: ["Railway Terminal", "ISBT", "Metro Station"]
  },
  {
    name: "Vasundhara Enclave",
    area: "East Delhi",
    coordinates: { latitude: 28.6219, longitude: 77.3089 },
    radius: 1.2,
    landmarks: ["Metro Station", "Market", "Residential Colony"]
  },
  {
    name: "Karkardooma",
    area: "East Delhi",
    coordinates: { latitude: 28.6469, longitude: 77.2889 },
    radius: 1.3,
    landmarks: ["Court Complex", "Metro Station", "Anand Vihar"]
  },
  {
    name: "Ashok Vihar",
    area: "North Delhi",
    coordinates: { latitude: 28.6942, longitude: 77.1814 },
    radius: 1.5,
    landmarks: ["Phase 1", "Phase 2", "Phase 3", "Wazirpur"]
  },
  {
    name: "Wazirpur",
    area: "North Delhi",
    coordinates: { latitude: 28.6942, longitude: 77.1642 },
    radius: 1.4,
    landmarks: ["Industrial Area", "Ashok Vihar", "Adarsh Nagar"]
  },
  {
    name: "Adarsh Nagar",
    area: "North Delhi",
    coordinates: { latitude: 28.7041, longitude: 77.1814 },
    radius: 1.2,
    landmarks: ["Metro Station", "Azadpur", "Model Town"]
  },
  {
    name: "Azadpur",
    area: "North Delhi",
    coordinates: { latitude: 28.7041, longitude: 77.1925 },
    radius: 1.6,
    landmarks: ["Mandi", "Metro Station", "Model Town"]
  },
  {
    name: "Malviya Nagar",
    area: "South Delhi",
    coordinates: { latitude: 28.5355, longitude: 77.2067 },
    radius: 1.3,
    landmarks: ["Metro Station", "Market", "Saket"]
  },
  {
    name: "Hauz Khas",
    area: "South Delhi",
    coordinates: { latitude: 28.5494, longitude: 77.2067 },
    radius: 1.4,
    landmarks: ["Metro Station", "Village", "Deer Park", "IIT Delhi"]
  },
  {
    name: "Green Park",
    area: "South Delhi",
    coordinates: { latitude: 28.5594, longitude: 77.2067 },
    radius: 1.1,
    landmarks: ["Metro Station", "Market", "Hauz Khas"]
  },
  {
    name: "AIIMS",
    area: "South Delhi",
    coordinates: { latitude: 28.5677, longitude: 77.2067 },
    radius: 1.0,
    landmarks: ["Hospital", "Metro Station", "Safdarjung"]
  },
  {
    name: "Munirka",
    area: "South Delhi",
    coordinates: { latitude: 28.5494, longitude: 77.1814 },
    radius: 1.2,
    landmarks: ["JNU", "Vasant Kunj", "RK Puram"]
  },
  {
    name: "RK Puram",
    area: "South Delhi",
    coordinates: { latitude: 28.5677, longitude: 77.1814 },
    radius: 1.5,
    landmarks: ["Sector 1", "Sector 2", "Munirka", "Vasant Kunj"]
  },
  {
    name: "Kalkaji",
    area: "South Delhi",
    coordinates: { latitude: 28.5355, longitude: 77.2519 },
    radius: 1.3,
    landmarks: ["Metro Station", "Temple", "Govindpuri"]
  },
  {
    name: "Govindpuri",
    area: "South Delhi",
    coordinates: { latitude: 28.5245, longitude: 77.2519 },
    radius: 1.2,
    landmarks: ["Metro Station", "Kalkaji", "Okhla"]
  },
  {
    name: "Okhla",
    area: "South Delhi",
    coordinates: { latitude: 28.5245, longitude: 77.2667 },
    radius: 1.8,
    landmarks: ["Industrial Area", "Jamia Millia", "Batla House"]
  }
];

// Calculate distance between two coordinates using Haversine formula
export const calculateDistance = (lat1, lon1, lat2, lon2) => {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  return distance;
};

// Find the nearest Delhi location
export const findNearestLocation = (userLat, userLon) => {
  let nearestLocation = null;
  let minDistance = Infinity;

  for (const location of delhiLocations) {
    const distance = calculateDistance(
      userLat, 
      userLon, 
      location.coordinates.latitude, 
      location.coordinates.longitude
    );

    if (distance < location.radius && distance < minDistance) {
      minDistance = distance;
      nearestLocation = {
        ...location,
        distanceFromUser: parseFloat(distance.toFixed(2))
      };
    }
  }

  return nearestLocation;
};

// Check if user is in a recognized Delhi area
export const isInDelhiArea = (userLat, userLon) => {
  const nearestLocation = findNearestLocation(userLat, userLon);
  return nearestLocation !== null;
};

// Get location suggestions based on partial name
export const getLocationSuggestions = (query) => {
  if (!query || query.length < 2) return [];
  
  const lowerQuery = query.toLowerCase();
  return delhiLocations
    .filter(location => 
      location.name.toLowerCase().includes(lowerQuery) ||
      location.area.toLowerCase().includes(lowerQuery) ||
      location.landmarks.some(landmark => 
        landmark.toLowerCase().includes(lowerQuery)
      )
    )
    .slice(0, 5); // Return top 5 matches
};

// Validate if coordinates are within Delhi NCR bounds
export const isWithinDelhiNCR = (lat, lon) => {
  // Expanded Delhi NCR bounds to include more areas
  const delhiBounds = {
    north: 28.9500,  // Extended north for Narela, etc.
    south: 28.3500,  // Extended south for Faridabad, etc.
    east: 77.5000,   // Extended east for Ghaziabad, etc.
    west: 76.7000    // Extended west for Gurgaon, etc.
  };

  const isInBounds = (
    lat >= delhiBounds.south && 
    lat <= delhiBounds.north &&
    lon >= delhiBounds.west && 
    lon <= delhiBounds.east
  );

  console.log(`üó∫Ô∏è Checking bounds for ${lat}, ${lon}: ${isInBounds}`);
  console.log(`üìç Bounds: N:${delhiBounds.north}, S:${delhiBounds.south}, E:${delhiBounds.east}, W:${delhiBounds.west}`);
  
  return isInBounds;
};

// Enhanced location detection with reverse geocoding
export const getAccurateLocation = async (lat, lon) => {
  console.log(`üîç Getting accurate location for: ${lat}, ${lon}`);
  
  try {
    // ALWAYS try reverse geocoding first for most accurate results
    console.log('üåê Attempting reverse geocoding for real-time location...');
    
    const geocodingUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`;
    
    try {
      const response = await fetch(geocodingUrl);
      if (response.ok) {
        const data = await response.json();
        console.log('üó∫Ô∏è Reverse geocoding data:', data);
        
        let locationName = 'Delhi NCR';
        let areaName = 'Delhi NCR Area';
        
        // Extract the most specific location information
        if (data.locality && data.locality !== 'Delhi') {
          locationName = data.locality;
          areaName = data.principalSubdivision || data.city || 'Delhi NCR';
        } else if (data.city && data.city !== 'Delhi') {
          locationName = data.city;
          areaName = data.principalSubdivision || 'Delhi NCR';
        } else if (data.principalSubdivision) {
          locationName = data.principalSubdivision;
          areaName = 'Delhi NCR';
        } else if (data.countryName === 'India') {
          // If we're in India but can't get specific location, check our predefined locations
          const nearestLocation = findNearestLocation(lat, lon);
          if (nearestLocation) {
            locationName = nearestLocation.name;
            areaName = nearestLocation.area;
          }
        }
        
        console.log(`‚úÖ Real-time location detected: ${locationName}, ${areaName}`);
        
        return {
          name: locationName,
          area: areaName,
          coordinates: { latitude: lat, longitude: lon },
          source: 'geocoding',
          accuracy: 'high',
          timestamp: new Date().toISOString()
        };
      }
    } catch (geocodingError) {
      console.log('‚ö†Ô∏è Reverse geocoding failed, trying predefined locations...');
    }
    
    // Fallback to predefined locations
    const nearestLocation = findNearestLocation(lat, lon);
    
    if (nearestLocation) {
      console.log('‚úÖ Found predefined location:', nearestLocation.name);
      return {
        name: nearestLocation.name,
        area: nearestLocation.area,
        coordinates: { latitude: lat, longitude: lon },
        source: 'predefined',
        accuracy: 'medium',
        timestamp: new Date().toISOString()
      };
    }
    
  } catch (error) {
    console.error('‚ö†Ô∏è Location detection failed:', error.message);
  }
  
  // Final fallback
  console.log('‚ö†Ô∏è Using fallback location detection');
  return {
    name: `Location ${lat.toFixed(4)}, ${lon.toFixed(4)}`,
    area: 'Delhi NCR Area',
    coordinates: { latitude: lat, longitude: lon },
    source: 'fallback',
    accuracy: 'low',
    timestamp: new Date().toISOString()
  };
};